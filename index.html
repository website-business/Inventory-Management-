import React, { useState, useEffect, useMemo } from 'react';

// URL ‡∏Ç‡∏≠‡∏á Google Sheets ‡∏ó‡∏µ‡πà‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡πÄ‡∏õ‡πá‡∏ô CSV
const VEHICLE_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZTa9PWUXGmxpu7YQPEug2HLzEbcl7-PG8cGqdLy5fVDoKE9BGCkDLUdKZsw3RjNCg1nVoZOul9qqO/pub?gid=0&single=true&output=csv';
const TRANSACTIONS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZTa9PWUXGmxpu7YQPEug2HLzEbcl7-PG8cGqdLy5fVDoKE9BGCkDLUdKZsw3RjNCg1nVoZOul9qqO/pub?gid=654756465&single=true&output=csv';
const LIFESPAN_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZTa9PWUXGmxpu7YQPEug2HLzEbcl7-PG8cGqdLy5fVDoKE9BGCkDLUdKZsw3RjNCg1nVoZOul9qqO/pub?gid=1305872211&single=true&output=csv';

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á CSV
const parseCSV = (csvText) => {
  const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
  if (lines.length === 0) return [];
  
  const parseRow = (row) => {
    const result = [];
    let insideQuote = false;
    let currentValue = "";
    for (let i = 0; i < row.length; i++) {
      const char = row[i];
      if (char === '"') {
        insideQuote = !insideQuote;
      } else if (char === ',' && !insideQuote) {
        result.push(currentValue);
        currentValue = "";
      } else {
        currentValue += char;
      }
    }
    result.push(currentValue);
    return result;
  };

  const headers = parseRow(lines[0]).map(h => h.trim());
  const result = [];
  for (let i = 1; i < lines.length; i++) {
    const obj = {};
    const currentLine = parseRow(lines[i]);
    headers.forEach((header, index) => {
      let val = currentLine[index] !== undefined ? currentLine[index].trim() : '';
      if(val.startsWith('"') && val.endsWith('"')) val = val.substring(1, val.length-1);
      obj[header] = val;
    });
    obj._rowIndex = i + 1; 
    result.push(obj);
  }
  return result;
};

const fetchWithTimeout = async (url, options, timeout = 15000) => {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  try {
    const response = await fetch(url, { ...options, signal: controller.signal });
    clearTimeout(id);
    return response;
  } catch (error) {
    clearTimeout(id);
    throw error;
  }
};

export default function App() {
  const [activeTab, setActiveTab] = useState('receive');
  const [vehicles, setVehicles] = useState([]);
  const [transactions, setTransactions] = useState([]);
  
  const [loading, setLoading] = useState(true); 
  const [isSyncing, setIsSyncing] = useState(false); 
  const [isOnline, setIsOnline] = useState(navigator.onLine);

  // Background Sync Tasks State (‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏Ñ‡πà 3 ‡∏≠‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
  const [syncTasks, setSyncTasks] = useState([]);

  // Form States
  const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
  const [productName, setProductName] = useState('');
  const [quantity, setQuantity] = useState('');
  const [totalPrice, setTotalPrice] = useState('');
  const [shopName, setShopName] = useState('');
  const [selectedVehicle, setSelectedVehicle] = useState('');
  const [partsCode, setPartsCode] = useState('');

  // History Filter States
  const [histType, setHistType] = useState('all');
  const [histVehicle, setHistVehicle] = useState('');
  const [histProduct, setHistProduct] = useState(''); 
  const [histStartDate, setHistStartDate] = useState('');
  const [histEndDate, setHistEndDate] = useState('');

  const [summarySearch, setSummarySearch] = useState('');
  const [viewShopName, setViewShopName] = useState('');

  // Modals & Settings
  const [detailModalItem, setDetailModalItem] = useState(null);
  const [modalFilterType, setModalFilterType] = useState('all');
  
  const [itemSettings, setItemSettings] = useState({}); 
  const [tempLifespan, setTempLifespan] = useState('');
  const [tempMinStock, setTempMinStock] = useState(''); 

  const [isRenamingItem, setIsRenamingItem] = useState(false);
  const [renameData, setRenameData] = useState({ newName: '', newPartsCode: '' });

  const [alertData, setAlertData] = useState({ show: false, message: '', type: 'info' });
  const [confirmData, setConfirmData] = useState({ show: false, message: '', confirmText: '', cancelText: '', onConfirm: null, onCancelAction: null });
  const [alertDetailModal, setAlertDetailModal] = useState({ show: false, info: null, transaction: null });
  const [clearPromptModal, setClearPromptModal] = useState({ show: false, transaction: null, reason: '', checker: '' });
  const [editModal, setEditModal] = useState({ show: false, originalData: null, currentData: {} });

  // Barcode Scanner State
  const [isScannerOpen, setIsScannerOpen] = useState(false);

  const closeConfirm = () => setConfirmData({ show: false, message: '', confirmText: '', cancelText: '', onConfirm: null, onCancelAction: null });

  const addSyncTask = (id, message) => {
    setSyncTasks(prev => {
      const newTasks = [...prev, { id, status: 'syncing', message }];
      return newTasks.slice(-3);
    });
  };
  const updateSyncTask = (id, status, message) => {
    setSyncTasks(prev => prev.map(t => t.id === id ? { ...t, status, message } : t));
  };
  const removeSyncTaskDelayed = (id, delay = 3000) => {
    setTimeout(() => {
      setSyncTasks(prev => prev.filter(t => t.id !== id));
    }, delay);
  };

  // ‡πÇ‡∏´‡∏•‡∏î Script ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Barcode Scanner ‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  useEffect(() => {
    // 1. ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ html5-qrcode
    const script = document.createElement('script');
    script.src = "https://unpkg.com/html5-qrcode";
    script.async = true;
    document.body.appendChild(script);

    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    const fetchData = async () => {
      const cachedTrans = localStorage.getItem('cachedTransactions_v3');
      const cachedVehicles = localStorage.getItem('cachedVehicles_v3');
      const cachedItemSettings = localStorage.getItem('cachedItemSettings_v3');
      
      if (cachedTrans && cachedVehicles) {
        setTransactions(JSON.parse(cachedTrans));
        setVehicles(JSON.parse(cachedVehicles));
        if(cachedItemSettings) setItemSettings(JSON.parse(cachedItemSettings));
        setLoading(false); 
        setIsSyncing(true); 
      } else {
        setLoading(true); 
      }

      try {
        const vehicleRes = await fetchWithTimeout(VEHICLE_CSV_URL, {}, 10000);
        const vehicleText = await vehicleRes.text();
        const parsedVehicles = parseCSV(vehicleText);

        const transRes = await fetchWithTimeout(TRANSACTIONS_CSV_URL, {}, 10000);
        const transText = await transRes.text();
        const parsedTrans = parseCSV(transText);

        const lifespanRes = await fetchWithTimeout(LIFESPAN_CSV_URL, {}, 10000);
        const lifespanText = await lifespanRes.text();
        const parsedLifespan = parseCSV(lifespanText);
        
        const settingsObj = {};
        parsedLifespan.forEach(row => {
          if (row['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']) {
            settingsObj[row['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'].trim()] = {
              lifespan: row['‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'] || '',
              minStock: row['‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥'] || '' 
            };
          }
        });

        setVehicles(parsedVehicles);
        setTransactions(parsedTrans);
        setItemSettings(settingsObj);

        localStorage.setItem('cachedVehicles_v3', JSON.stringify(parsedVehicles));
        localStorage.setItem('cachedTransactions_v3', JSON.stringify(parsedTrans));
        localStorage.setItem('cachedItemSettings_v3', JSON.stringify(settingsObj));

      } catch (error) {
        console.error("Error fetching data:", error);
      } finally {
        setLoading(false);
        setIsSyncing(false);
      }
    };

    fetchData();

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
      if (document.body.contains(script)) {
        document.body.removeChild(script);
      }
    };
  }, []);

  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå
  useEffect(() => {
    let html5QrcodeScanner = null;

    if (isScannerOpen) {
      // ‡∏£‡∏≠‡πÉ‡∏´‡πâ script ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
      const checkLibrary = setInterval(() => {
        if (window.Html5QrcodeScanner) {
          clearInterval(checkLibrary);
          html5QrcodeScanner = new window.Html5QrcodeScanner(
            "reader",
            { fps: 10, qrbox: {width: 250, height: 250} },
            /* verbose= */ false
          );
          html5QrcodeScanner.render(
            (decodedText) => {
              // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏û‡∏≤‡∏£‡πå‡∏ó ‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
              handlePartsCodeChange({ target: { value: decodedText } });
              
              // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏ï‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß
              setAlertData({ show: true, message: `‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${decodedText}`, type: 'success' });
              
              setIsScannerOpen(false);
            },
            (errorMessage) => {
              // ‡∏ã‡πà‡∏≠‡∏ô error ‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î
            }
          );
        }
      }, 100);

      return () => {
        clearInterval(checkLibrary);
        if (html5QrcodeScanner) {
          html5QrcodeScanner.clear().catch(error => console.error("Failed to clear scanner", error));
        }
      };
    }
  }, [isScannerOpen]);

  useEffect(() => {
    if (transactions.length > 0) {
      localStorage.setItem('cachedTransactions_v3', JSON.stringify(transactions));
    }
  }, [transactions]);

  const inventory = useMemo(() => {
    const acc = {};
    const sortedTrans = [...transactions].sort((a, b) => new Date(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']));
    
    sortedTrans.forEach(curr => {
      const product = (curr['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '').trim();
      const type = curr['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'];
      const qty = parseFloat(curr['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'] || 0);
      const parts = (curr['‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà'] || '').trim();

      if (!product) return;
      if (!acc[product]) acc[product] = { in: 0, out: 0, balance: 0, partsCode: '' };

      if (type === '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' && parts !== '') {
        acc[product].partsCode = parts;
      }

      if (type === '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤') {
        acc[product].in += qty;
        acc[product].balance += qty;
      } else if (type === '‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å') {
        acc[product].out += qty;
        acc[product].balance -= qty;
      }
    });
    return acc;
  }, [transactions]);

  const existingProducts = Object.keys(inventory).sort();
  const existingPartsCodes = [...new Set(transactions.map(t => (t['‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà'] || '').trim()).filter(Boolean))].sort();

  const handleProductNameChange = (e) => {
    const newName = e.target.value;
    setProductName(newName);
    if (inventory[newName.trim()] && inventory[newName.trim()].partsCode) {
      setPartsCode(inventory[newName.trim()].partsCode);
    } else if (newName === '') {
      setPartsCode(''); 
    }
  };

  const handlePartsCodeChange = (e) => {
    const newCode = e.target.value;
    setPartsCode(newCode);
    if (newCode.trim() !== '') {
      const matchedProduct = Object.keys(inventory).find(p => 
        (inventory[p].partsCode || '').toLowerCase() === newCode.trim().toLowerCase()
      );
      if (matchedProduct) setProductName(matchedProduct);
    }
  };

  const filteredInventoryProducts = existingProducts.filter(p => {
    const searchLower = summarySearch.toLowerCase();
    const nameMatch = p.toLowerCase().includes(searchLower);
    const partsMatch = (inventory[p].partsCode || '').toLowerCase().includes(searchLower);
    return nameMatch || partsMatch;
  });

  const checkLifespanWarning = () => {
    const targetLifespan = itemSettings[productName.trim()]?.lifespan;
    if (activeTab !== 'dispatch' || !productName.trim() || !selectedVehicle || !targetLifespan) return null;
    const pastDispatches = transactions.filter(t => 
      t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] === '‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å' && (t['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim() === productName.trim() && 
      (t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ'] === selectedVehicle || t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å'] === selectedVehicle)
    ).sort((a, b) => new Date(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']));

    if (pastDispatches.length > 0) {
      const lastDispatch = pastDispatches[0];
      const pastDate = new Date(lastDispatch['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
      const currentDate = new Date(date);
      const diffInDays = (currentDate - pastDate) / (1000 * 60 * 60 * 24);
      const monthsSince = diffInDays / 30.44;
      const targetLifespanNum = parseFloat(targetLifespan);
      if (monthsSince < targetLifespanNum) {
        return { lastDate: lastDispatch['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'], monthsSince: monthsSince.toFixed(1), targetLifespan: targetLifespanNum };
      }
    }
    return null;
  };

  const lifespanWarning = checkLifespanWarning();

  const getAlertDetailedInfo = (problemTx) => {
    const pastDispatches = transactions.filter(t => 
      t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] === '‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å' && (t['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim() === (problemTx['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim() && 
      (t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ'] === problemTx['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ'] || t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å'] === problemTx['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ']) &&
      new Date(t['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) < new Date(problemTx['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'])
    ).sort((a, b) => new Date(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']));
    const prevTx = pastDispatches[0];
    if (!prevTx) return null;
    const prevDate = new Date(prevTx['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
    const currDate = new Date(problemTx['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
    const diffDays = Math.floor((currDate - prevDate) / (1000 * 60 * 60 * 24));
    const diffMonths = (diffDays / 30.44).toFixed(1);
    return {
      prevDateStr: prevTx['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'], currDateStr: problemTx['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'], diffDays, diffMonths,
      targetLifespan: itemSettings[(problemTx['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim()]?.lifespan || '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏'
    };
  };

  const alertTransactions = useMemo(() => {
    const dynamicAlerts = [];
    const dispatches = transactions.filter(t => t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] === '‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å');
    const grouped = {};
    dispatches.forEach(t => {
        const v = t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ'] || t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å'];
        const p = (t['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim();
        if (!v || !p) return;
        const key = `${v}_${p}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(t);
    });

    Object.values(grouped).forEach(group => {
        group.sort((a, b) => new Date(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']));
        for (let i = 1; i < group.length; i++) {
            const currTx = group[i];
            const prevTx = group[i-1];
            const pName = (currTx['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim();
            const targetLifespan = itemSettings[pName]?.lifespan;
            if (targetLifespan) {
                const diffDays = (new Date(currTx['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(prevTx['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'])) / (1000 * 60 * 60 * 24);
                const diffMonths = diffDays / 30.44;
                if (diffMonths < parseFloat(targetLifespan)) {
                    const status = currTx['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô'] || '';
                    if (!status.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß')) {
                        if (!dynamicAlerts.some(a => a._rowIndex === currTx._rowIndex)) dynamicAlerts.push(currTx);
                    }
                }
            }
        }
    });
    return dynamicAlerts.sort((a, b) => new Date(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']));
  }, [transactions, itemSettings]);

  const lowStockAlerts = useMemo(() => {
    const alerts = [];
    existingProducts.forEach(product => {
      const balance = inventory[product].balance;
      const minStockStr = itemSettings[product]?.minStock;
      if (minStockStr && minStockStr.trim() !== '') {
        const threshold = parseFloat(minStockStr);
        if (!isNaN(threshold) && balance <= threshold) {
          alerts.push({ product, partsCode: inventory[product].partsCode, balance, threshold });
        }
      }
    });
    return alerts.sort((a, b) => a.balance - b.balance);
  }, [inventory, itemSettings, existingProducts]);

  const totalAlertCount = alertTransactions.length + lowStockAlerts.length;
  const existingShops = [...new Set(transactions.filter(t => t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] === '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' && t['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤']).map(t => t['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤']))].filter(Boolean);
  const existingDispatchedVehicles = [...new Set(transactions.filter(t => t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] === '‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å' && t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ']).map(t => t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ']))].filter(Boolean);

  const handlePreSubmit = (type) => {
    if (!productName.trim() || !quantity) return setAlertData({ show: true, message: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô", type: 'error' });
    
    if (!isOnline) {
      setAlertData({ show: true, message: "‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡∏≠‡∏¢‡∏π‡πà! ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏£‡∏ö)", type: 'error' });
      return;
    }

    if (type === 'dispatch') {
      const currentBalance = inventory[productName.trim()]?.balance || 0;
      const dispatchQty = parseFloat(quantity);
      if (dispatchQty > currentBalance) {
        return setAlertData({ show: true, message: `‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏¥‡∏Å!\n‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å (${dispatchQty}) ‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (${currentBalance})`, type: 'error' });
      }
    }

    if (type === 'dispatch' && lifespanWarning) {
      const confirmMsg = `‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å!\n‡∏£‡∏ñ‡∏£‡∏´‡∏±‡∏™ ${selectedVehicle} ‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏ö‡∏¥‡∏Å "${productName}" ‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${lifespanWarning.lastDate} (‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ ${lifespanWarning.monthsSince} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)\n‡∏ã‡∏∂‡πà‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î (${lifespanWarning.targetLifespan} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)\n‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏ö‡∏¥‡∏Å‡∏ã‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö?`;
      setConfirmData({
        show: true, message: confirmMsg, confirmText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠', cancelText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        onConfirm: () => { closeConfirm(); executeSubmit(type, true); },
        onCancelAction: closeConfirm
      });
    } else {
      executeSubmit(type, false);
    }
  };

  const executeSubmit = async (type, isAlertPending) => {
    let finalPartsCode = partsCode;
    if (type === 'dispatch' && !partsCode.trim() && inventory[productName.trim()]?.partsCode) {
      finalPartsCode = inventory[productName.trim()].partsCode;
    }

    const taskId = Date.now();
    const maxRowIndex = transactions.length > 0 ? Math.max(...transactions.map(t => t._rowIndex || 0)) : 1;
    const newTransaction = {
      'action': 'saveTransaction', '_rowIndex': maxRowIndex + 1,
      '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': date, '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': type === 'receive' ? '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' : '‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å',
      '‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà': finalPartsCode.trim(), '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': productName.trim(), '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': parseFloat(quantity),
      '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°': type === 'receive' ? parseFloat(totalPrice || 0) : '', '‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤': type === 'receive' ? shopName : '', '‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ': type === 'dispatch' ? selectedVehicle : '',
      '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô': isAlertPending ? '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' : '', '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•': '', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏î‡∏¢': ''
    };

    setTransactions([newTransaction, ...transactions]);
    setProductName(''); setPartsCode(''); setQuantity(''); setTotalPrice(''); setShopName(''); setSelectedVehicle('');
    
    addSyncTask(taskId, `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...`);

    try {
      const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwA6nJhSKQGZIX_4xV4_rtqnHd0acNdQrqK8Aa0JnC_lgVKlfLOqfg_h7BM7Xa-6JRHRQ/exec';
      await fetchWithTimeout(WEB_APP_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(newTransaction) }, 15000);
      updateSyncTask(taskId, 'success', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      removeSyncTaskDelayed(taskId);
    } catch (error) {
      updateSyncTask(taskId, 'error', '‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)');
      removeSyncTaskDelayed(taskId, 6000);
    }
  };

  const handleDeleteTransaction = (transaction) => {
    setConfirmData({
      show: true,
      message: `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${transaction['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']} "${transaction['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']}" ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${transaction['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']} ‡∏ä‡∏¥‡πâ‡∏ô?`,
      confirmText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', cancelText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
      onConfirm: async () => {
        closeConfirm();
        const taskId = Date.now();
        setTransactions(transactions.filter(t => t._rowIndex !== transaction._rowIndex));
        addSyncTask(taskId, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');

        try {
          const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwA6nJhSKQGZIX_4xV4_rtqnHd0acNdQrqK8Aa0JnC_lgVKlfLOqfg_h7BM7Xa-6JRHRQ/exec';
          await fetchWithTimeout(WEB_APP_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'deleteTransaction', oldData: transaction }) }, 15000);
          updateSyncTask(taskId, 'success', '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          removeSyncTaskDelayed(taskId);
        } catch (error) {
          updateSyncTask(taskId, 'error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå');
          removeSyncTaskDelayed(taskId, 5000);
        }
      },
      onCancelAction: closeConfirm
    });
  };

  const openEditModal = (transaction) => setEditModal({ show: true, originalData: transaction, currentData: { ...transaction } });

  const executeEdit = async () => {
    const taskId = Date.now();
    const payload = { action: 'editTransaction', oldData: editModal.originalData, newData: editModal.currentData };
    
    setTransactions(transactions.map(t => t._rowIndex === editModal.originalData._rowIndex ? editModal.currentData : t));
    setEditModal({ show: false, originalData: null, currentData: {} });
    addSyncTask(taskId, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');

    try {
      const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwA6nJhSKQGZIX_4xV4_rtqnHd0acNdQrqK8Aa0JnC_lgVKlfLOqfg_h7BM7Xa-6JRHRQ/exec';
      const res = await fetchWithTimeout(WEB_APP_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) }, 15000);
      const data = await res.json();
      if(data.status === 'error') throw new Error(data.message);
      
      updateSyncTask(taskId, 'success', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      removeSyncTaskDelayed(taskId);
    } catch (error) {
      updateSyncTask(taskId, 'error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏ô‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå');
      removeSyncTaskDelayed(taskId, 5000);
    }
  };

  const handleGlobalRename = async () => {
    if (!renameData.newName.trim()) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà");
    const taskId = Date.now();
    
    const payload = { action: 'globalRename', oldName: detailModalItem, newName: renameData.newName.trim(), newPartsCode: renameData.newPartsCode.trim() };
    
    setTransactions(transactions.map(t => {
      if ((t['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim() === (detailModalItem||'').trim()) {
        return { ...t, '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': renameData.newName.trim(), '‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà': renameData.newPartsCode.trim() };
      }
      return t;
    }));
    if (itemSettings[detailModalItem]) {
      const newSettings = { ...itemSettings };
      newSettings[renameData.newName.trim()] = newSettings[detailModalItem];
      delete newSettings[detailModalItem];
      setItemSettings(newSettings);
    }
    setDetailModalItem(renameData.newName.trim());
    setIsRenamingItem(false);
    
    addSyncTask(taskId, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö...');

    try {
      const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwA6nJhSKQGZIX_4xV4_rtqnHd0acNdQrqK8Aa0JnC_lgVKlfLOqfg_h7BM7Xa-6JRHRQ/exec';
      const res = await fetchWithTimeout(WEB_APP_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) }, 15000);
      const data = await res.json();
      if(data.status === 'error') throw new Error(data.message);
      
      updateSyncTask(taskId, 'success', '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      removeSyncTaskDelayed(taskId);
    } catch (error) {
      updateSyncTask(taskId, 'error', '‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•)');
      removeSyncTaskDelayed(taskId, 5000);
    }
  };

  const getFilteredTransactions = () => {
    return transactions.filter(t => {
      if (histType !== 'all' && t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] !== histType) return false;
      if (histVehicle && (t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ'] || '') !== histVehicle) return false;
      if (histProduct && (t['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || '').trim() !== histProduct.trim()) return false;
      if (histStartDate && t['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] < histStartDate) return false;
      if (histEndDate && t['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] > histEndDate) return false;
      return true;
    }).sort((a, b) => new Date(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'])); 
  };

  const getShopTransactions = () => {
    return transactions.filter(t => t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] === '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' && t['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤'] === viewShopName)
                       .sort((a, b) => new Date(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']));
  };

  const handleSaveSettings = async () => {
    const taskId = Date.now();
    const newSettingsData = { action: 'saveLifespan', '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': detailModalItem, '‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô': tempLifespan, '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥': tempMinStock };
    
    setItemSettings(prev => ({ ...prev, [detailModalItem]: { lifespan: tempLifespan, minStock: tempMinStock } }));
    addSyncTask(taskId, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô...');

    try {
      const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwA6nJhSKQGZIX_4xV4_rtqnHd0acNdQrqK8Aa0JnC_lgVKlfLOqfg_h7BM7Xa-6JRHRQ/exec';
      await fetchWithTimeout(WEB_APP_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(newSettingsData) }, 15000);
      updateSyncTask(taskId, 'success', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      removeSyncTaskDelayed(taskId);
    } catch (error) {
      updateSyncTask(taskId, 'error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤');
      removeSyncTaskDelayed(taskId, 5000);
    }
  };

  const openClearPrompt = (transaction) => setClearPromptModal({ show: true, transaction: transaction, reason: '', checker: '' });

  const executeClearAlertWithReason = async () => {
    if (!clearPromptModal.checker.trim()) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö");
    const taskId = Date.now();
    const transaction = clearPromptModal.transaction;
    const payload = {
      'action': 'clearAlert', '_rowIndex': transaction._rowIndex,
      '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': transaction['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'], '‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ': transaction['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ'], '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': transaction['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'], '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': transaction['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'],
      '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà': '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•': clearPromptModal.reason || '-', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏î‡∏¢': clearPromptModal.checker
    };
    
    setTransactions(transactions.map(t => {
      if (t._rowIndex === transaction._rowIndex) {
          return { ...t, '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô': '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•': clearPromptModal.reason || '-', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏î‡∏¢': clearPromptModal.checker };
      }
      return t;
    }));
    setClearPromptModal({ show: false, transaction: null, reason: '', checker: '' });
    addSyncTask(taskId, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô...');

    try {
      const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwA6nJhSKQGZIX_4xV4_rtqnHd0acNdQrqK8Aa0JnC_lgVKlfLOqfg_h7BM7Xa-6JRHRQ/exec';
      const response = await fetchWithTimeout(WEB_APP_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) }, 15000);
      const result = await response.json();
      if (result.status === 'error') throw new Error(result.message);
      
      updateSyncTask(taskId, 'success', '‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      removeSyncTaskDelayed(taskId);
    } catch (error) {
      updateSyncTask(taskId, 'error', '‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß!');
      removeSyncTaskDelayed(taskId, 5000);
    }
  };

  if (loading) {
    return (
      <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100">
        <svg className="animate-spin h-10 w-10 text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <div className="text-xl font-bold text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 pb-10 relative overflow-x-hidden">
      
      {/* Toast Notification Container */}
      <div className="fixed bottom-4 right-4 z-[9999] flex flex-col gap-2 pointer-events-none">
        {syncTasks.map(task => (
          <div key={task.id} className={`flex items-center gap-3 px-4 py-3 rounded shadow-lg text-sm font-bold text-white animate-slideInRight ${
            task.status === 'syncing' ? 'bg-blue-600' : task.status === 'success' ? 'bg-green-600' : 'bg-red-600'
          }`}>
            {task.status === 'syncing' && <svg className="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>}
            {task.status === 'success' && <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>}
            {task.status === 'error' && <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>}
            {task.message}
          </div>
        ))}
      </div>

      {/* Offline Banner */}
      {!isOnline && (
        <div className="bg-red-600 text-white text-center py-1.5 text-xs font-bold w-full shadow-md z-50 relative flex items-center justify-center gap-2">
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
          ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡∏≠‡∏¢‡∏π‡πà (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô)
        </div>
      )}

      <header className="bg-blue-800 text-white p-4 shadow-md sticky top-0 z-10">
        <div className="max-w-5xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-3">
            <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 002-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
            <h1 className="text-2xl font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
          </div>
          {isSyncing && isOnline && (
             <div className="flex items-center text-xs font-medium text-blue-200 animate-pulse">
                <svg className="animate-spin h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
             </div>
          )}
        </div>
      </header>

      <main className="max-w-5xl mx-auto mt-6 px-4">
        <div className="flex bg-white rounded-t-lg shadow-sm overflow-x-auto mb-6 border-b">
          <button onClick={() => setActiveTab('receive')} className={`flex-1 min-w-[100px] py-4 text-center font-medium transition-colors ${activeTab === 'receive' ? 'bg-blue-50 text-blue-700 border-b-2 border-blue-700' : 'text-gray-500 hover:bg-gray-50'}`}>üì• ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</button>
          <button onClick={() => setActiveTab('dispatch')} className={`flex-1 min-w-[100px] py-4 text-center font-medium transition-colors ${activeTab === 'dispatch' ? 'bg-orange-50 text-orange-600 border-b-2 border-orange-600' : 'text-gray-500 hover:bg-gray-50'}`}>üì§ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å</button>
          <button onClick={() => setActiveTab('summary')} className={`flex-1 min-w-[100px] py-4 text-center font-medium transition-colors ${activeTab === 'summary' ? 'bg-green-50 text-green-700 border-b-2 border-green-700' : 'text-gray-500 hover:bg-gray-50'}`}>üì¶ ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</button>
          <button onClick={() => setActiveTab('shops')} className={`flex-1 min-w-[100px] py-4 text-center font-medium transition-colors ${activeTab === 'shops' ? 'bg-indigo-50 text-indigo-700 border-b-2 border-indigo-700' : 'text-gray-500 hover:bg-gray-50'}`}>üè™ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
          <button onClick={() => setActiveTab('history')} className={`flex-1 min-w-[100px] py-4 text-center font-medium transition-colors ${activeTab === 'history' ? 'bg-purple-50 text-purple-700 border-b-2 border-purple-700' : 'text-gray-500 hover:bg-gray-50'}`}>üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
          <button onClick={() => setActiveTab('alerts')} className={`relative flex-1 min-w-[120px] py-4 text-center font-medium transition-colors ${activeTab === 'alerts' ? 'bg-red-50 text-red-700 border-b-2 border-red-700' : 'text-gray-500 hover:bg-gray-50'}`}>
            ‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            {totalAlertCount > 0 && <span className="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full">{totalAlertCount}</span>}
          </button>
        </div>

        <div className="bg-white p-6 rounded-b-lg shadow-md border border-gray-100 min-h-[500px]">
          
          {activeTab === 'receive' && (
            <div className="space-y-5 animate-fadeIn max-w-2xl mx-auto">
              <h2 className="text-xl font-bold text-gray-800 border-l-4 border-blue-500 pl-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div><label className="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" /></div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà (Parts)</label>
                  <div className="flex gap-2">
                    <input type="text" list="receive-parts-list" value={partsCode} onChange={handlePartsCodeChange} placeholder="‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà" className="w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" />
                    <button type="button" onClick={() => setIsScannerOpen(true)} className="bg-blue-100 text-blue-700 p-2.5 rounded-md hover:bg-blue-200 transition-colors" title="‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î">üì∑</button>
                  </div>
                  <datalist id="receive-parts-list">{existingPartsCodes.map(code => <option key={code} value={code} />)}</datalist>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ <span className="text-red-500">*</span></label>
                  <input type="text" list="receive-products-list" value={productName} onChange={handleProductNameChange} placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" className="w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" />
                  <datalist id="receive-products-list">{existingProducts.map(p => <option key={p} value={p} />)}</datalist>
                </div>
                <div><label className="block text-sm font-medium text-gray-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <span className="text-red-500">*</span></label><input type="number" min="0" step="0.01" value={quantity} onChange={(e) => setQuantity(e.target.value)} className="w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" /></div>
                <div><label className="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input type="number" min="0" step="0.01" value={totalPrice} onChange={(e) => setTotalPrice(e.target.value)} className="w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" /></div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏ú‡∏π‡πâ‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</label>
                  <input type="text" list="receive-shops-list" value={shopName} onChange={(e) => setShopName(e.target.value)} className="w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" />
                  <datalist id="receive-shops-list">{existingShops.map(s => <option key={s} value={s} />)}</datalist>
                </div>
              </div>
              <button onClick={() => handlePreSubmit('receive')} className={`w-full mt-6 text-white font-bold py-3.5 px-4 rounded-md shadow transition-colors bg-blue-600 hover:bg-blue-700`}>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å</button>
            </div>
          )}

          {activeTab === 'dispatch' && (
            <div className="space-y-5 animate-fadeIn max-w-2xl mx-auto">
              <h2 className="text-xl font-bold text-gray-800 border-l-4 border-orange-500 pl-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏Å</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div><label className="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 outline-none" /></div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà (Parts)</label>
                  <div className="flex gap-2">
                    <input type="text" list="dispatch-parts-list" value={partsCode} onChange={handlePartsCodeChange} placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå ‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î" className="w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 outline-none" />
                    <button type="button" onClick={() => setIsScannerOpen(true)} className="bg-orange-100 text-orange-700 p-2.5 rounded-md hover:bg-orange-200 transition-colors" title="‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î">üì∑</button>
                  </div>
                  <datalist id="dispatch-parts-list">{existingPartsCodes.map(code => <option key={code} value={code} />)}</datalist>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏ö‡∏¥‡∏Å <span className="text-red-500">*</span></label>
                  <input type="text" list="dispatch-products-list" value={productName} onChange={handleProductNameChange} placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" className="w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 outline-none" />
                  <datalist id="dispatch-products-list">{existingProducts.map(p => <option key={p} value={p}>{p}</option>)}</datalist>
                  {inventory[productName.trim()] && <p className={`text-xs font-bold mt-1 ${inventory[productName.trim()].balance <= 0 ? 'text-red-500' : 'text-blue-600'}`}>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏™‡∏ï‡πä‡∏≠‡∏Å: {inventory[productName.trim()].balance}</p>}
                </div>
                <div><label className="block text-sm font-medium text-gray-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å <span className="text-red-500">*</span></label><input type="number" min="0" step="0.01" value={quantity} onChange={(e) => setQuantity(e.target.value)} className="w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 outline-none" /></div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏´‡πâ‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ / ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                  <input type="text" list="vehicles-list" value={selectedVehicle} onChange={(e) => setSelectedVehicle(e.target.value)} className={`w-full p-2.5 border rounded-md outline-none focus:ring-2 ${lifespanWarning ? 'border-red-400 focus:ring-red-500 bg-red-50' : 'border-gray-300 focus:ring-orange-500'}`} />
                  <datalist id="vehicles-list">{vehicles.map((v, i) => v['‡∏£‡∏´‡∏±‡∏™'] ? <option key={i} value={v['‡∏£‡∏´‡∏±‡∏™']}>{v['‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'] ? `(‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ${v['‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô']})` : ''}</option> : null)}</datalist>
                  {lifespanWarning && (
                    <div className="mt-2 text-sm text-red-600 bg-red-100 p-2.5 rounded border border-red-200">
                      <strong>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> ‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠ {lifespanWarning.lastDate} <br/>(‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ {lifespanWarning.monthsSince} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏à‡∏≤‡∏Å {lifespanWarning.targetLifespan} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
                    </div>
                  )}
                </div>
              </div>
              <button onClick={() => handlePreSubmit('dispatch')} className={`w-full mt-6 text-white font-bold py-3.5 px-4 rounded-md shadow transition-colors bg-orange-600 hover:bg-orange-700`}>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å</button>
            </div>
          )}

          {activeTab === 'summary' && (
            <div className="space-y-4 animate-fadeIn">
              <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-4">
                <h2 className="text-xl font-bold text-gray-800 border-l-4 border-green-500 pl-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</h2>
                <input 
                  type="text" 
                  placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà..." 
                  value={summarySearch}
                  onChange={(e) => setSummarySearch(e.target.value)}
                  className="p-2 border border-gray-300 rounded-md text-sm outline-none focus:ring-2 focus:ring-green-500 w-full sm:w-64"
                />
              </div>
              <div className="overflow-x-auto border border-gray-200 rounded-lg shadow-sm">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-100">
                    <tr><th className="px-6 py-3.5 text-left text-xs font-bold text-gray-600 uppercase">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà)</th><th className="px-6 py-3.5 text-right text-sm font-bold text-blue-800 uppercase w-32">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th></tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {filteredInventoryProducts.length === 0 ? (
                      <tr><td colSpan="2" className="px-6 py-8 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</td></tr>
                    ) : (
                      filteredInventoryProducts.map((product, idx) => (
                        <tr key={idx} className="hover:bg-blue-50 cursor-pointer transition-colors" onClick={() => { 
                          setDetailModalItem(product); 
                          setTempLifespan(itemSettings[product]?.lifespan || ''); 
                          setTempMinStock(itemSettings[product]?.minStock || '');
                          setModalFilterType('all'); 
                          setIsRenamingItem(false); 
                        }}>
                          <td className="px-6 py-4 text-sm font-semibold text-gray-900">
                            <div className="flex items-center gap-2">
                              {product} 
                              {itemSettings[product]?.lifespan && <span className="text-xs font-normal bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">‡∏≠‡∏≤‡∏¢‡∏∏: {itemSettings[product].lifespan} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>}
                              {itemSettings[product]?.minStock && <span className="text-xs font-normal bg-orange-100 text-orange-800 px-2 py-0.5 rounded-full">‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ &lt;= {itemSettings[product].minStock}</span>}
                            </div>
                            {inventory[product].partsCode && <div className="text-xs text-gray-500 mt-1 font-normal">‡∏û‡∏≤‡∏£‡πå‡∏ó: {inventory[product].partsCode}</div>}
                          </td>
                          <td className={`px-6 py-4 text-sm text-right font-bold bg-blue-50/30 ${inventory[product].balance <= (itemSettings[product]?.minStock || 0) ? 'text-red-600' : 'text-blue-700'}`}>
                            {inventory[product].balance}
                          </td>
                        </tr>
                      ))
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {activeTab === 'shops' && (
            <div className="space-y-6 animate-fadeIn">
              <h2 className="text-xl font-bold text-gray-800 border-l-4 border-indigo-500 pl-3 mb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
              <select value={viewShopName} onChange={(e) => setViewShopName(e.target.value)} className="w-full md:w-1/2 p-2.5 border rounded-md text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>
                {existingShops.map((s, i) => <option key={i} value={s}>{s}</option>)}
              </select>
              {viewShopName && (
                <div className="overflow-x-auto border border-gray-200 rounded-lg mt-4 shadow-sm">
                  <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-100">
                      <tr><th className="px-4 py-3 text-left text-xs font-bold text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th className="px-4 py-3 text-left text-xs font-bold text-gray-600">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th className="px-4 py-3 text-right text-xs font-bold text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th className="px-4 py-3 text-right text-xs font-bold text-gray-600">‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th></tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-100">
                      {getShopTransactions().map((t, i) => (
                        <tr key={i} className="hover:bg-gray-50"><td className="px-4 py-3 text-sm">{t['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']}</td><td className="px-4 py-3 text-sm font-medium">{t['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']}</td><td className="px-4 py-3 text-sm text-right font-bold">{t['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']}</td><td className="px-4 py-3 text-sm text-right text-green-600">{t['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°'] ? `${parseFloat(t['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°']).toLocaleString()} ‡∏ø` : '-'}</td></tr>
                      ))}
                    </tbody>
                    <tfoot className="bg-indigo-50 border-t border-indigo-100">
                      <tr>
                        <td colSpan="4" className="px-4 py-3 text-right text-sm font-bold text-indigo-900">‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ: {getShopTransactions().reduce((sum, t) => sum + (parseFloat(t['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°']) || 0), 0).toLocaleString()} ‡∏ø</td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              )}
            </div>
          )}

          {activeTab === 'history' && (
            <div className="space-y-6 animate-fadeIn">
              <h2 className="text-xl font-bold text-gray-800 border-l-4 border-purple-500 pl-3 mb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
              <div className="bg-purple-50 p-4 rounded-lg grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-4">
                <div><label className="block text-xs font-bold text-purple-800 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select value={histType} onChange={(e) => setHistType(e.target.value)} className="w-full p-2 border rounded text-sm outline-none"><option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option value="‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</option><option value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å">‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å</option></select></div>
                <div><label className="block text-xs font-bold text-purple-800 mb-1">‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</label><select value={histProduct} onChange={(e) => setHistProduct(e.target.value)} className="w-full p-2 border rounded text-sm outline-none bg-white"><option value="">-- ‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>{existingProducts.map(p => <option key={p} value={p}>{p}</option>)}</select></div>
                <div><label className="block text-xs font-bold text-purple-800 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ</label><select value={histVehicle} onChange={(e) => setHistVehicle(e.target.value)} disabled={histType === '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤'} className="w-full p-2 border rounded text-sm outline-none"><option value="">-- ‡∏£‡∏ñ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏±‡∏ô --</option>{existingDispatchedVehicles.map(code => <option key={code} value={code}>{code}</option>)}</select></div>
                <div><label className="block text-xs font-bold text-purple-800 mb-1">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" value={histStartDate} onChange={(e) => setHistStartDate(e.target.value)} className="w-full p-2 border rounded text-sm outline-none" /></div>
                <div><label className="block text-xs font-bold text-purple-800 mb-1">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" value={histEndDate} onChange={(e) => setHistEndDate(e.target.value)} className="w-full p-2 border rounded text-sm outline-none" /></div>
              </div>

              <div className="overflow-x-auto border border-gray-200 rounded-lg shadow-sm">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-100">
                    <tr>
                      <th className="px-3 py-3 text-left text-xs font-bold text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                      <th className="px-3 py-3 text-left text-xs font-bold text-gray-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                      <th className="px-3 py-3 text-left text-xs font-bold text-gray-600">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                      <th className="px-3 py-3 text-right text-xs font-bold text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                      <th className="px-3 py-3 text-left text-xs font-bold text-gray-600">‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ/‡∏£‡πâ‡∏≤‡∏ô</th>
                      <th className="px-3 py-3 text-left text-xs font-bold text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                      <th className="px-3 py-3 text-center text-xs font-bold text-gray-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-100">
                    {getFilteredTransactions().map((t, i) => (
                      <tr key={i} className="hover:bg-gray-50">
                        <td className="px-3 py-3 text-sm text-gray-600">{t['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']}</td>
                        <td className="px-3 py-3 text-sm"><span className={`px-2 py-1 text-xs rounded-full ${t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] === '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}`}>{t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']}</span></td>
                        <td className="px-3 py-3 text-sm font-medium">{t['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']} <span className="text-xs text-gray-400 block">{t['‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà']}</span></td>
                        <td className="px-3 py-3 text-sm text-right font-bold">{t['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']}</td>
                        <td className="px-3 py-3 text-sm text-gray-500">{t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] === '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' ? t['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤'] : t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ']}</td>
                        <td className="px-3 py-3 text-xs text-gray-500 max-w-[150px] truncate">{t['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô']}</td>
                        <td className="px-3 py-3 text-center whitespace-nowrap">
                          <button onClick={() => openEditModal(t)} className="text-blue-500 hover:text-blue-700 mx-1 bg-blue-50 p-1.5 rounded">‚úèÔ∏è</button>
                          <button onClick={() => handleDeleteTransaction(t)} className="text-red-500 hover:text-red-700 mx-1 bg-red-50 p-1.5 rounded">üóëÔ∏è</button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {activeTab === 'alerts' && (
            <div className="space-y-8 animate-fadeIn">
              
              {/* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà 1: ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î */}
              <div>
                <h2 className="text-xl font-bold text-orange-600 border-l-4 border-orange-500 pl-3 mb-4">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å</h2>
                <div className="overflow-x-auto border border-orange-200 rounded-lg shadow-sm">
                  <table className="min-w-full divide-y divide-orange-200">
                    <thead className="bg-orange-50">
                      <tr><th className="px-4 py-3 text-left text-xs font-bold text-orange-800">‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</th><th className="px-4 py-3 text-left text-xs font-bold text-orange-800">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th className="px-4 py-3 text-center text-xs font-bold text-orange-800">‡∏à‡∏∏‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏ä‡∏¥‡πâ‡∏ô)</th><th className="px-4 py-3 text-right text-xs font-bold text-orange-800">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th></tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-100">
                      {lowStockAlerts.length === 0 ? (
                        <tr><td colSpan="4" className="px-4 py-8 text-center text-gray-500">‚úÖ ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥</td></tr>
                      ) : (
                        lowStockAlerts.map((item, i) => (
                          <tr key={i} className="hover:bg-orange-50">
                            <td className="px-4 py-3 text-sm text-gray-500">{item.partsCode || '-'}</td>
                            <td className="px-4 py-3 text-sm font-bold text-gray-900">{item.product}</td>
                            <td className="px-4 py-3 text-sm text-center text-gray-600">&le; {item.threshold}</td>
                            <td className="px-4 py-3 text-sm text-right font-bold text-red-600">{item.balance}</td>
                          </tr>
                        ))
                      )}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà 2: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö) */}
              <div>
                <h2 className="text-xl font-bold text-red-800 border-l-4 border-red-600 pl-3 mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)</h2>
                <div className="overflow-x-auto border border-red-200 rounded-lg shadow-sm">
                  <table className="min-w-full divide-y divide-red-200">
                    <thead className="bg-red-50">
                      <tr><th className="px-4 py-3 text-left text-xs font-bold text-red-800">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å</th><th className="px-4 py-3 text-left text-xs font-bold text-red-800">‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ</th><th className="px-4 py-3 text-left text-xs font-bold text-red-800">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th className="px-4 py-3 text-center text-xs font-bold text-red-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th className="px-4 py-3 text-right text-xs font-bold text-red-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-100">
                      {alertTransactions.length === 0 ? (
                        <tr><td colSpan="5" className="px-4 py-12 text-center text-gray-500">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</td></tr>
                      ) : (
                        alertTransactions.map((t, i) => (
                          <tr key={i} className="hover:bg-red-50 transition-colors">
                            <td className="px-4 py-3 text-sm font-medium text-gray-900">{t['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']}</td>
                            <td className="px-4 py-3 text-sm font-bold text-orange-600">{t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ']}</td>
                            <td className="px-4 py-3 text-sm font-medium text-gray-900">{t['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']} <span className="text-xs text-gray-500">({t['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']} ‡∏ä‡∏¥‡πâ‡∏ô)</span></td>
                            <td className="px-4 py-3 text-center text-sm"><button onClick={() => setAlertDetailModal({ show: true, info: getAlertDetailedInfo(t), transaction: t })} className="text-blue-600 underline">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button></td>
                            <td className="px-4 py-3 text-right"><button onClick={() => openClearPrompt(t)} className="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-xs shadow-sm">‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß</button></td>
                          </tr>
                        ))
                      )}
                    </tbody>
                  </table>
                </div>
              </div>
              
            </div>
          )}
        </div>
      </main>

      {/* --- MODAL: Barcode Scanner --- */}
      {isScannerOpen && (
        <div className="fixed inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center z-[100] p-4">
          <div className="bg-white rounded-lg shadow-2xl w-full max-w-md p-6 relative">
            <button onClick={() => setIsScannerOpen(false)} className="absolute top-4 right-4 text-gray-500 hover:text-red-500 text-2xl z-10">&times;</button>
            <h3 className="text-lg font-bold mb-4 text-center">‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î / QR Code</h3>
            
            {/* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á */}
            <div id="reader" className="w-full overflow-hidden rounded-md border border-gray-300 bg-black"></div>
            
            <p className="text-xs text-gray-500 text-center mt-4">‡∏´‡∏±‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
          </div>
        </div>
      )}

      {/* --- MODAL: ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î (Edit Modal) ‡∏•‡πá‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏û‡∏≤‡∏£‡πå‡∏ó‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å --- */}
      {editModal.show && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
          <div className="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 animate-fadeIn">
            <h3 className="text-xl font-bold text-blue-800 mb-4 border-b pb-2">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ({editModal.currentData['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']})</h3>
            <div className="grid grid-cols-2 gap-4">
              <div><label className="block text-xs font-bold text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" value={editModal.currentData['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']} onChange={(e)=>setEditModal({...editModal, currentData: {...editModal.currentData, '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': e.target.value}})} className="w-full p-2 border rounded text-sm"/></div>
              
              {/* ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà ‡πÅ‡∏•‡∏∞ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÑ‡∏î‡πâ ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô */}
              {editModal.currentData['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] === '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' ? (
                <>
                  <div><label className="block text-xs font-bold text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</label><input type="text" value={editModal.currentData['‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà']||''} onChange={(e)=>setEditModal({...editModal, currentData: {...editModal.currentData, '‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà': e.target.value}})} className="w-full p-2 border focus:ring-2 focus:ring-blue-500 rounded text-sm"/></div>
                  <div className="col-span-2"><label className="block text-xs font-bold text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="text" value={editModal.currentData['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']} onChange={(e)=>setEditModal({...editModal, currentData: {...editModal.currentData, '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤': e.target.value}})} className="w-full p-2 border focus:ring-2 focus:ring-blue-500 rounded text-sm"/></div>
                </>
              ) : (
                <>
                  <div><label className="block text-xs font-bold text-gray-400 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà (‡∏•‡πá‡∏≠‡∏Å)</label><input type="text" value={editModal.currentData['‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà']||''} disabled className="w-full p-2 border rounded text-sm bg-gray-100 text-gray-500 cursor-not-allowed"/></div>
                  <div className="col-span-2"><label className="block text-xs font-bold text-gray-400 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏•‡πá‡∏≠‡∏Å)</label><input type="text" value={editModal.currentData['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']} disabled className="w-full p-2 border rounded text-sm bg-gray-100 text-gray-500 cursor-not-allowed"/></div>
                </>
              )}
              
              <div><label className="block text-xs font-bold text-gray-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label><input type="number" value={editModal.currentData['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']} onChange={(e)=>setEditModal({...editModal, currentData: {...editModal.currentData, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': e.target.value}})} className="w-full p-2 border rounded text-sm"/></div>
              
              {editModal.currentData['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] === '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' ? (
                <>
                  <div><label className="block text-xs font-bold text-gray-700 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</label><input type="number" value={editModal.currentData['‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°']||''} onChange={(e)=>setEditModal({...editModal, currentData: {...editModal.currentData, '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°': e.target.value}})} className="w-full p-2 border rounded text-sm"/></div>
                  <div className="col-span-2"><label className="block text-xs font-bold text-gray-700 mb-1">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="text" value={editModal.currentData['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤']||''} onChange={(e)=>setEditModal({...editModal, currentData: {...editModal.currentData, '‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤': e.target.value}})} className="w-full p-2 border rounded text-sm"/></div>
                </>
              ) : (
                <div className="col-span-2"><label className="block text-xs font-bold text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ</label><input type="text" value={editModal.currentData['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ']||''} onChange={(e)=>setEditModal({...editModal, currentData: {...editModal.currentData, '‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ': e.target.value}})} className="w-full p-2 border rounded text-sm"/></div>
              )}
            </div>
            <div className="mt-6 flex justify-end gap-2">
              <button onClick={() => setEditModal({show:false, originalData:null, currentData:{}})} className="px-4 py-2 border rounded text-gray-600 bg-gray-50 hover:bg-gray-100 font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button onClick={executeEdit} className={`px-4 py-2 text-white rounded font-bold transition-colors bg-blue-600 hover:bg-blue-700`}>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            </div>
          </div>
        </div>
      )}

      {/* --- MODAL: ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏ï‡∏±‡∏ß (‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) --- */}
      {detailModalItem && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 p-4">
          <div className="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[85vh] flex flex-col animate-fadeIn">
            
            <div className="p-5 border-b flex justify-between items-start bg-gray-50 rounded-t-lg">
              <div className="w-full">
                {!isRenamingItem ? (
                  <div className="flex items-center gap-3">
                    <h3 className="text-xl font-bold text-gray-800">
                      ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: {detailModalItem} 
                      {inventory[detailModalItem]?.partsCode && <span className="text-sm font-normal text-gray-500 ml-2">(‡∏û‡∏≤‡∏£‡πå‡∏ó: {inventory[detailModalItem].partsCode})</span>}
                    </h3>
                    <button onClick={() => {
                        setRenameData({ newName: detailModalItem, newPartsCode: inventory[detailModalItem]?.partsCode || '' });
                        setIsRenamingItem(true);
                      }} 
                      className="text-blue-500 hover:text-blue-700 text-sm bg-blue-50 px-2 py-1 rounded border border-blue-200" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠/‡∏û‡∏≤‡∏£‡πå‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö">
                      ‚úèÔ∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                  </div>
                ) : (
                  <div className="bg-blue-50 p-3 rounded border border-blue-200 mb-2 w-full pr-8">
                    <p className="text-xs font-bold text-blue-800 mb-2">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà (‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</p>
                    <div className="flex flex-col sm:flex-row gap-2">
                      <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" value={renameData.newName} onChange={(e) => setRenameData({...renameData, newName: e.target.value})} className="p-2 border rounded text-sm flex-1" />
                      <input type="text" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà" value={renameData.newPartsCode} onChange={(e) => setRenameData({...renameData, newPartsCode: e.target.value})} className="p-2 border rounded text-sm w-full sm:w-1/3" />
                      <button onClick={handleGlobalRename} className={`text-white px-3 py-2 rounded text-sm font-bold bg-blue-600 hover:bg-blue-700`}>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                      <button onClick={() => setIsRenamingItem(false)} className="bg-gray-300 hover:bg-gray-400 px-3 py-2 rounded text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                  </div>
                )}
                <p className="text-sm text-blue-600 font-semibold mt-1">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: {inventory[detailModalItem]?.balance || 0}</p>
              </div>
              <button onClick={() => { setDetailModalItem(null); setIsRenamingItem(false); }} className="text-gray-400 hover:text-red-500 ml-4 text-xl">‚ùå</button>
            </div>

            <div className="p-4 border-b bg-yellow-50 flex flex-col sm:flex-row items-end gap-3">
              <div className="flex-1 w-full">
                <label className="block text-sm font-bold text-yellow-800 mb-1">‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
                <input type="number" value={tempLifespan} onChange={(e) => setTempLifespan(e.target.value)} placeholder="‡πÄ‡∏ä‡πà‡∏ô 24 (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á)" className="w-full p-2 border border-yellow-300 rounded outline-none focus:ring-2 focus:ring-yellow-500" />
              </div>
              <div className="flex-1 w-full">
                <label className="block text-sm font-bold text-orange-800 mb-1">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ (‡∏ä‡∏¥‡πâ‡∏ô)</label>
                <input type="number" value={tempMinStock} onChange={(e) => setTempMinStock(e.target.value)} placeholder="‡πÄ‡∏ä‡πà‡∏ô 5 (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á)" className="w-full p-2 border border-orange-300 rounded outline-none focus:ring-2 focus:ring-orange-500" />
              </div>
              <button onClick={handleSaveSettings} className={`w-full sm:w-auto text-white font-bold py-2 px-6 rounded transition-colors bg-yellow-600 hover:bg-yellow-700`}>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
            </div>
            
            <div className="px-6 py-3 bg-gray-50 border-b flex items-center gap-2">
              <label className="text-sm font-bold text-gray-700">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞:</label>
              <select 
                value={modalFilterType} 
                onChange={(e) => setModalFilterType(e.target.value)}
                className="p-1 border border-gray-300 rounded text-sm outline-none focus:border-blue-500"
              >
                <option value="all">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</option>
                <option value="‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å</option>
              </select>
            </div>

            <div className="p-0 overflow-y-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-white sticky top-0 shadow-sm">
                  <tr><th className="px-4 py-3 text-left text-xs font-bold text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th className="px-4 py-3 text-left text-xs font-bold text-gray-500">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th className="px-4 py-3 text-right text-xs font-bold text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th className="px-4 py-3 text-left text-xs font-bold text-gray-500">‡∏£‡∏ñ/‡∏£‡πâ‡∏≤‡∏ô</th><th className="px-4 py-3 text-center text-xs font-bold text-gray-500">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-100">
                  {transactions.filter(t => (t['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤']||'').trim() === (detailModalItem||'').trim())
                    .filter(t => modalFilterType === 'all' || t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] === modalFilterType)
                    .sort((a,b)=>new Date(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) - new Date(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'])).map((t, i) => (
                    <tr key={i} className="hover:bg-gray-50">
                      <td className="px-4 py-2 text-sm">{t['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']}</td><td className="px-4 py-2 text-sm"><span className="bg-gray-200 px-2 py-0.5 rounded text-xs">{t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']}</span></td><td className="px-4 py-2 text-sm text-right font-bold">{t['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']}</td><td className="px-4 py-2 text-sm">{t['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']==='‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤'?t['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤']:t['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ']}</td>
                      <td className="px-4 py-2 text-center">
                        <button onClick={() => openEditModal(t)} className="mx-1 text-xl">üìù</button>
                        <button onClick={() => handleDeleteTransaction(t)} className="mx-1 text-xl text-red-500">üóëÔ∏è</button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <div className="p-3 border-t bg-gray-50 text-right"><button onClick={() => { setDetailModalItem(null); setIsRenamingItem(false); }} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 font-bold rounded">‡∏õ‡∏¥‡∏î</button></div>
          </div>
        </div>
      )}

      {/* Alert Modals */}
      {alertData.show && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[80] p-4">
          <div className="bg-white rounded-lg p-6 text-center shadow-xl w-80"><h3 className="text-lg font-bold mb-2">{alertData.type === 'error' ? '‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î' : (alertData.type === 'warning' ? '‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô' : '‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')}</h3><p className="mb-4 text-sm whitespace-pre-line">{alertData.message}</p><button onClick={() => setAlertData({ show: false, message: '', type: 'info' })} className={`w-full text-white font-bold py-2 rounded transition-colors ${alertData.type === 'error' ? 'bg-red-600 hover:bg-red-700' : (alertData.type === 'warning' ? 'bg-orange-500 hover:bg-orange-600' : 'bg-blue-600 hover:bg-blue-700')}`}>‡∏ï‡∏Å‡∏•‡∏á</button></div>
        </div>
      )}
      
      {confirmData.show && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[80] p-4">
          <div className="bg-white rounded-lg p-6 shadow-xl max-w-md w-full">
            <h3 className="text-lg font-bold mb-3 flex items-center gap-2">
              <svg className="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
              ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
            </h3>
            <p className="mb-6 text-sm text-gray-600 whitespace-pre-line leading-relaxed">{confirmData.message}</p>
            <div className="flex flex-col sm:flex-row-reverse gap-2">
              <button onClick={confirmData.onConfirm} className="w-full sm:w-auto px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold transition-colors">
                {confirmData.confirmText || '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô'}
              </button>
              <button onClick={confirmData.onCancelAction || closeConfirm} className="w-full sm:w-auto px-4 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded font-bold transition-colors">
                {confirmData.cancelText || '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Clear Alert Modal for Manager */}
      {clearPromptModal.show && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] p-4">
          <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <h3 className="text-xl font-bold text-green-700 mb-4">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h3>
            <div className="space-y-4">
              <div><label className="block text-sm font-bold mb-1">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</label><textarea value={clearPromptModal.reason} onChange={(e) => setClearPromptModal({ ...clearPromptModal, reason: e.target.value })} className="w-full p-2 border rounded outline-none h-20" /></div>
              <div><label className="block text-sm font-bold mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö *</label><input type="text" value={clearPromptModal.checker} onChange={(e) => setClearPromptModal({ ...clearPromptModal, checker: e.target.value })} className="w-full p-2 border rounded outline-none" /></div>
            </div>
            <div className="mt-6 flex justify-end gap-2"><button onClick={() => setClearPromptModal({ show: false, transaction: null, reason: '', checker: '' })} className="px-4 py-2 bg-gray-200 rounded font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button onClick={executeClearAlertWithReason} className={`px-4 py-2 text-white rounded font-bold transition-colors bg-green-600 hover:bg-green-700`}>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
          </div>
        </div>
      )}
      
      {/* Alert Detail Modal */}
      {alertDetailModal.show && alertDetailModal.info && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] p-4">
           <div className="bg-white rounded-lg p-6 max-w-sm w-full"><h3 className="text-lg font-bold text-red-600 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏ö‡∏¥‡∏Å‡∏ã‡πâ‡∏≥</h3><div className="text-sm space-y-2"><p>‡∏£‡∏ñ: <b>{alertDetailModal.transaction['‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ']}</b></p><p>‡πÄ‡∏ö‡∏¥‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤: {alertDetailModal.info.prevDateStr}</p><p>‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ: {alertDetailModal.info.currDateStr}</p><p className="text-red-500 font-bold">‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡πÄ‡∏û‡∏µ‡∏¢‡∏á {alertDetailModal.info.diffMonths} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ {alertDetailModal.info.targetLifespan} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</p></div><button onClick={()=>setAlertDetailModal({show:false, info:null, transaction:null})} className="mt-4 w-full bg-gray-200 hover:bg-gray-300 py-2 rounded font-bold">‡∏õ‡∏¥‡∏î</button></div>
        </div>
      )}
      
      <style dangerouslySetInnerHTML={{__html: `
        .animate-fadeIn { animation: fadeIn 0.2s ease-out; } 
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slideInRight { animation: slideInRight 0.3s ease-out; }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
      `}} />
    </div>
  );
}